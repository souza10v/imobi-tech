<div
  *ngIf="property as p"
  class="group overflow-hidden border-0 shadow-lg hover:shadow-2xl transition-all duration-500 bg-gradient-to-br from-background via-background to-muted/30 transform hover:scale-[1.02] rounded-xl cursor-pointer"
  role="button" tabindex="0"
  [attr.aria-label]="'Ver detalhes do imóvel ' + (p.title || p.shortDescription || '')"
  (click)="onClick.emit(p)"
  (keydown.enter)="onClick.emit(p)"
  (keydown.space)="onClick.emit(p); $event.preventDefault()"
>
  <!-- Imagem + Overlays -->
  <div class="relative h-64 overflow-hidden">
    <img
      [src]="currentImage(p)"
      [alt]="p.title || p.shortDescription || 'Imagem do imóvel'"
      class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
      loading="lazy" decoding="async" referrerpolicy="no-referrer"
      (error)="handleImgError(p)"
    />

    <!-- Overlay em gradiente ao hover -->
    <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>

    <!-- Badge de Status -->
    <span
      class="absolute top-4 left-4 px-2.5 py-1 rounded-full text-xs font-semibold backdrop-blur-sm border border-white/10"
      [ngClass]="getStatusColor(p.status)"
    >
      {{ getStatusText(p.status) }}
    </span>

    <!-- Badge de Destaque -->
    <span
      *ngIf="p.featured"
      class="absolute top-4 right-4 bg-gradient-to-r from-yellow-400 via-yellow-500 to-orange-500 text-white border-0 shadow-lg animate-pulse px-2.5 py-1 rounded-full text-xs font-semibold flex items-center gap-1"
    >
      <!-- Star icon -->
      <svg class="w-3 h-3" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
        <path d="M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
      </svg>
      Destaque
    </span>

    <!-- Botão Favorito -->
    <button
      *ngIf="isAuthenticated"
      type="button"
      (click)="toggleFavorite($event)"
      class="absolute top-16 right-4 h-10 w-10 rounded-full backdrop-blur-sm transition-all duration-300 shadow-lg transform hover:scale-110 border border-white/10 flex items-center justify-center
        "
      [ngClass]="isFavorite
        ? 'bg-red-500/90 text-white hover:bg-red-600 shadow-red-500/25'
        : 'bg-white/20 text-white hover:bg-white/40'"
      aria-label="Favoritar"
    >
      <!-- Heart icon -->
      <svg class="h-4 w-4" viewBox="0 0 24 24" [attr.fill]="isFavorite ? 'currentColor' : 'none'" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round"
          d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.93 0-3.595 1.13-4.312 2.753-.717-1.623-2.382-2.753-4.312-2.753C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z"/>
      </svg>
    </button>

    <!-- Preço (tag no canto) -->
    <div class="absolute bottom-4 left-4 transform group-hover:scale-105 transition-transform duration-300">
      <div class="bg-gradient-to-r from-black/90 via-black/80 to-transparent backdrop-blur-sm rounded-lg px-4 py-2 border border-white/10">
        <span class="text-white font-bold text-xl tracking-tight">
          {{ p.price | currency:'BRL':'symbol':'1.0-0' }}
        </span>
      </div>
    </div>

    <!-- Botão visualizar (olho) -->
    <a
      [routerLink]="['/property', p.id]"
      class="absolute bottom-4 right-4 h-12 w-12 rounded-full bg-gradient-to-r from-primary to-primary/80 hover:from-primary/80 hover:to-primary backdrop-blur-sm shadow-lg transform hover:scale-110 transition-all duration-300 flex items-center justify-center"
      aria-label="Ver detalhes"
      (click)="$event.stopPropagation()"
    >
      <!-- Eye icon -->
      <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
        <circle cx="12" cy="12" r="3"></circle>
      </svg>
    </a>
  </div>

  <!-- Conteúdo -->
  <div class="p-6 space-y-4">
    <!-- Tipo -->
    <span class="inline-flex w-fit bg-muted/50 hover:bg-muted text-xs font-medium px-2.5 py-1 rounded-full border border-border/50">
      {{ p.type ? (p.type === 'apartment' || p.type === 'APARTMENT' ? 'Apartamento' : p.type === 'house' || p.type === 'HOUSE' ? 'Casa' : 'Comercial') : (propertyTypeToPt(p.type) || 'Imóvel') }}
    </span>

    <!-- Título -->
    <h3 class="font-bold text-lg leading-tight line-clamp-2 group-hover:text-primary transition-colors duration-300">
      {{ p.title || p.shortDescription || 'Imóvel' }}
    </h3>

    <!-- Localização -->
    <div class="flex items-center text-muted-foreground group-hover:text-foreground transition-colors duration-300">
      <!-- MapPin -->
      <svg class="h-4 w-4 mr-2 flex-shrink-0 text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 21s-6-4.35-6-9a6 6 0 1112 0c0 4.65-6 9-6 9z"/>
        <circle cx="12" cy="12" r="2.5"></circle>
      </svg>
      <span class="text-sm truncate">{{ p.neighborhood }}{{ p.city ? ', ' + p.city : '' }}</span>
    </div>

    <!-- Detalhes -->
    <div class="flex items-center justify-between pt-3 border-t border-border/50">
      <div class="flex items-center gap-4 text-sm text-muted-foreground">
        <div class="flex items-center gap-1 bg-muted/30 rounded-full px-2 py-1">
          <!-- Bed -->
          <app-icon-bedroom></app-icon-bedroom>
          <span class="font-medium">{{ p.bedrooms }}</span>
        </div>
        <div class="flex items-center gap-1 bg-muted/30 rounded-full px-2 py-1">
          <!-- Bath -->
          <app-icon-bathroom></app-icon-bathroom>
          <span class="font-medium">{{ p.bathrooms ?? 0 }}</span>
        </div>
        <div class="flex items-center gap-1 bg-muted/30 rounded-full px-2 py-1">
          <!-- Square -->
          <app-square-intersect></app-square-intersect>
          <span class="font-medium">{{ p.areaBuilt }}m²</span>
        </div>
      </div>
    </div>

    <!-- Prévia de features -->
    <div *ngIf="(p.features?.length || 0) > 0" class="pt-3 border-t border-border/50">
      <div class="flex flex-wrap gap-1">
        <span
          *ngFor="let feat of (p.features || []).slice(0,2); let i = index"
          class="text-xs bg-primary/5 border border-primary/20 text-primary hover:bg-primary/10 rounded-full px-2 py-1"
        >
          {{ feat }}
        </span>
        <span
          *ngIf="(p.features?.length || 0) > 2"
          class="text-xs bg-accent/10 border border-accent/30 text-accent-foreground rounded-full px-2 py-1"
        >
          +{{ (p.features?.length || 0) - 2 }} mais
        </span>
      </div>
    </div>
  </div>
</div>
